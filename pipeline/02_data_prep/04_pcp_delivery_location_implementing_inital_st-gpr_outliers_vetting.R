#### Initial outlier vetting ####
### Chiara Sumich ###
### 12.02.2024 ###

#### Load packages
rm(list = ls())
pacman::p_load(data.table, ggplot2, gtools, tidyverse, haven, labelled)

## loading functions
source("/ihme/cc_resources/libraries/current/r/get_crosswalk_version.R")
source("/ihme/cc_resources/libraries/current/r/save_crosswalk_version.R")
'%!in%' <- function(x,y)!('%in%'(x,y))

VERSION <- Sys.Date()

#### Third round vetting ####
## I forgot Mexico!!
## defining variables
pub_hosp_crosswalk_version_id <- 49721 # 48858 #47461
pub_hosp_bundle_version_id <- 51230 #50431
priv_hosp_crosswalk_version_id <- 48859
priv_hosp_bundle_version_id <- 50432
pub_prim_crosswalk_version_id <- 48860
pub_prim_bundle_version_id <- 50433
priv_prim_crosswalk_version_id <- 48861 
priv_prim_bundle_version_id <- 50434 
ngo_hosp_crosswalk_version_id<- 50298
ngo_hosp_bundle_version_id<-51994
ngo_prim_crosswalk_version_id<-50297
ngo_prim_bundle_version_id<-51995

## pulling crosswalk versions and updating outliers
# pub_hosp
pub_hosp <- get_crosswalk_version(pub_hosp_crosswalk_version_id)
#variance fix: if variance is less than 1e-12, change to 1e-12
pub_hosp$variance <- ifelse(pub_hosp$variance <= 1e-12, 1e-11, pub_hosp$variance)
pub_hosp <- pub_hosp %>% 
  mutate(is_outlier = case_when(nid == 395908 ~ 1,
                                nid == 81748 ~ 0,
                                nid == 218565 ~ 1,
                                nid == 27615 ~ 1,
                                nid == 56241 & year_id %in% c(2009, 2010) ~ 1,
                                nid == 4779 ~ 1, 
                                nid == 396050 ~ 1, 
                                nid == 77388 ~ 0,
                                nid == 20829 ~ 0,
                                nid == 13465 ~ 1,
                                nid == 218555 ~ 0,
                                nid == 18854 ~ 1,
                                nid == 440151 ~ 0,
                                nid == 21126 ~ 1, 
                                nid == 504808 & year_id %in% c(2017, 2018, 2019, 2020) ~ 1,
                                nid == 230049 ~ 1, 
                                nid == 218566 ~ 1, 
                                nid == 76708 ~ 1, 
                                nid == 155335 & year_id %in% c(2006, 2007) ~ 1,
                                nid == 394719 & year_id %in% c(2017, 2018) ~ 1, 
                                nid == 483328 ~ 1, 
                                nid == 393876 ~ 1,
                                nid == 8618 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 8667 ~ 1,
                                nid == 343465 ~ 1,
                                nid == 483328 ~ 1,
                                nid == 383328 ~ 1, 
                                nid == 387640 ~ 1,
                                nid == 468566 ~ 1,
                                nid == 462027 & year_id %in% c(2018,2019) ~ 1,
                                nid == 45777 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 12489 ~ 1, 
                                nid == 20947 ~ 0,
                                nid == 20954 ~ 0,
                                nid == 32421 ~ 0,
                                nid == 223669 ~ 0, 
                                nid == 74460 ~ 1, 
                                nid == 527435 & year_id %in% c(2021,2022) ~ 1,
                                nid == 523643 & year_id %in% c(2021) ~ 1,
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid == 488697 ~ 1,
                                nid == 20947 ~ 0,
                                nid == 12489 ~ 1,
                                nid == 12455 ~ 1,
                                nid == 74460 ~ 1,
                                nid == 341838 ~ 1,
                                nid == 327591 ~ 1,
                                nid == 416582 ~ 0,
                                nid == 509345 & year_id %in% c(2020,2021) ~ 1,
                                nid == 260403 ~ 1, 
                                location_id == 141 & (val == 0.000 | val == 0)  ~ 1,
                                location_id == 130 & (val == 0 | val == 0.00)  ~ 1, #Mexico outlier if at 0                              
                                nid %in% c(107174,107172,107123,236187,236213,265259,335931,387644) ~ 1, 
                                nid == 12608 & year_id %in% c(2004, 2005) ~ 0, 
                                location_id == 44860 ~ 0,
                                TRUE ~ is_outlier))
#subset to ethiopia only
#pub_hosp = pub_hosp %>% filter(location_id %in% c(179,44861,44853,44854,44857,44862,44860,44859,44855,60908,44856,94364,95069,44852))
openxlsx::write.xlsx(pub_hosp, #paste0("/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/pub_hosp/delivery_location_bundle_10530_pub_hosp_", VERSION, ".xlsx"), 
                     paste0("/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/delivery_location_bundle_10530_pub_hosp_", VERSION, ".xlsx"),
                     rowNames = FALSE, 
                     sheetName="extraction")

# priv_hosp
priv_hosp <- get_crosswalk_version(priv_hosp_crosswalk_version_id)
priv_hosp$variance <- ifelse(priv_hosp$variance <= 1e-12, 1e-11, priv_hosp$variance)

priv_hosp <- priv_hosp %>% 
  mutate(is_outlier = case_when(nid == 395908 ~ 1,
                                nid == 81748 ~ 0,
                                nid == 4779 ~ 1, 
                                nid == 13218 & year_id %in% c(1999) ~ 1,
                                nid == 218555 ~ 0,
                                nid == 396050 ~ 1, 
                                nid == 20829 ~ 0,
                                nid == 218555 ~ 0,
                                nid == 56151 ~1,
                                nid == 27615 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 440151 ~ 0,
                                #nid == 234733 ~ 1,
                                nid == 77388 ~ 0,
                                nid == 394719 & year_id %in% c(2017, 2018) ~ 1,
                                nid == 155335 & year_id %in% c(2006, 2007) ~ 1,
                                nid == 76709 ~ 1, 
                                nid == 488697 & year_id %in% c(2018, 2019) ~ 1, 
                                nid == 200697 & year_id %in% c(2013:2014) ~ 1, 
                                nid == 8115 ~ 1, 
                                nid == 393876 ~ 1,
                                nid == 13465 ~ 1,
                                nid == 27615 ~ 1, 
                                nid == 303458 ~ 1,
                                nid == 21126 ~ 1, 
                                nid == 81748 ~ 1,
                                nid == 504808 ~ 1,
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid == 230049 ~ 1, 
                                nid == 55956 ~ 1,
                                nid == 327591 ~ 1,
                                nid == 157021 ~ 1, 
                                nid == 483328 ~ 1, 
                                nid == 56241 & year_id %in% c(2009, 2010) ~ 1,
                                nid == 8618 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 8667 ~ 1,
                                nid == 343465 ~ 1,
                                nid == 483328 ~ 1,
                                nid == 12489 ~ 1,
                                nid == 12455 ~ 1,
                                nid == 74460 ~ 1,
                                nid == 341838 ~ 1,
                                nid == 383328 ~ 1, 
                                nid == 425183 ~ 1,
                                nid == 387640 ~ 1,
                                nid == 468566 ~ 1, 
                                nid == 45777 ~ 1,
                                nid == 30431 ~ 1,
                                nid == 20235 ~ 1,
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid == 77395 & year_id == 2009~ 1, 
                                nid == 200707 ~ 1, 
                                nid == 20947 ~ 0,
                                nid == 509345 & year_id %in% c(2020,2021) ~ 1,
                                #nid == 20865 ~ 1,
                                location_id == 141 & val == 0 ~ 1,
                                location_id == 130 & (val == 0 | val == 0.00)  ~ 1, #Mexico outleir if at 0                              
                                nid == 12489 ~ 1, 
                                nid == 74460 ~ 1,
                                nid == 462027 ~ 1, 
                                nid == 8684 ~ 1, 
                                nid == 20947 ~ 0,
                                nid == 20954 ~ 0,
                                nid == 19391 ~ 1,
                                nid == 32421 ~ 0,
                                nid == 223669 ~ 0, 
                                nid == 74460 ~ 1, 
                                nid == 260403 ~ 1, 
                                nid == 56151 ~ 1,
                                nid == 19391 ~ 1,
                                nid == 488697 ~ 1,
                                nid == 505231 ~ 1,
                                nid == 416582 ~ 0,
                                nid == 505378 ~ 0,
                                location_id == 123 & (val == 0 | val == 0.00)  ~ 1, #Peru outleir if at 0
                                nid == 81748 ~ 1,
                                location_id == 44860 ~ 0,
                                TRUE ~ is_outlier))
priv_hosp = priv_hosp %>% mutate(is_outlier = case_when(
  nid == 81748 ~ 1,
  TRUE ~ is_outlier
))
priv_hosp = priv_hosp %>% filter(location_id %in% c(179,44861,44853,44854,44857,44862,44860,44859,44855,60908,44856,94364,95069,44852))
openxlsx::write.xlsx(priv_hosp, "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/priv_hosp/delivery_location_bundle_10554_priv_hosp_2025-06-05.xlsx", 
                     rowNames = FALSE, 
                     sheetName="extraction")

# pub_prim
pub_prim <- get_crosswalk_version(pub_prim_crosswalk_version_id)
pub_prim$variance <- ifelse(pub_prim$variance <= 1e-12, 1e-11, pub_prim$variance)
pub_prim <- pub_prim %>% 
  mutate(is_outlier = case_when(nid == 395908 ~ 1,
                                nid == 81748 ~ 0,
                                nid == 393876 ~ 1,
                                nid == 218565 ~ 1,
                                nid == 327591 ~ 1,
                                nid == 504808 ~ 1,
                                nid == 4779 ~1, 
                                nid == 27615 ~ 1,
                                nid == 462027 ~ 1, 
                                nid == 77388 ~ 0,
                                nid == 20829 ~ 0,
                                nid == 396050 ~ 1, 
                                nid == 20829 ~ 0,
                                nid == 218555 ~ 0,
                                nid == 234733 ~ 0,
                                nid == 13465 ~ 1,
                                nid == 76709 ~ 1, 
                                nid == 21126 ~ 1, 
                                nid == 19464 ~ 1, 
                                nid == 504808 ~ 1,
                                nid == 200697 & year_id %in% c(2013:2014) ~ 1, 
                                #nid == 56151 ~ 1, 
                                nid == 18815 ~ 1, 
                                nid == 466732 ~ 1, 
                                nid == 286782 ~ 1, 
                                nid == 26919 ~ 1, 
                                nid == 230049 ~ 1, 
                                nid == 20638 ~ 1, 
                                nid == 407869 ~ 1, 
                                nid == 452894 ~ 1, 
                                nid == 19350 ~ 1,
                                nid == 218566 ~ 1, 
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid == 19324 ~ 0,
                                nid == 10364 ~ 1,
                                nid == 31750 ~ 1, 
                                nid == 483328 ~ 1, 
                                nid == 56241 & year_id %in% c(2009, 2010) ~ 1,
                                nid == 8618 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 8667 ~ 1,
                                nid == 343465 ~ 1,
                                nid == 483328 ~ 1,
                                nid == 12489 ~ 1,
                                nid == 12455 ~ 1,
                                nid == 74460 ~ 1,
                                nid == 341838 ~ 1,
                                nid == 383328 ~ 1, 
                                nid == 387640 ~ 1,
                                nid == 468566 ~ 1, 
                                nid == 18979 ~ 1, 
                                nid == 45777 ~ 1,
                                nid == 376265 ~ 1, 
                                nid == 11781 ~ 1, 
                                nid == 20796 ~ 1, 
                                nid == 488697 & year_id %in% c(2018, 2019) ~ 1, 
                                nid == 155335 & year_id %in% c(2006, 2007) ~ 1,
                                nid == 206075 ~ 1, 
                                nid == 244455 ~ 1, 
                                nid == 18531 ~ 1,
                                nid == 56148 ~ 1, 
                                nid == 27215 ~ 1, 
                                nid == 20852 ~ 1, 
                                nid == 20875 ~ 1, 
                                nid == 20947 ~ 0,
                                nid == 20954 ~ 0,
                                nid == 32421 ~ 0,
                                nid == 223669 ~ 0, 
                                nid == 8684 ~ 1, 
                                nid == 20947 ~ 0,
                                nid == 509345 & year_id %in% c(2020,2021) ~ 1,
                                nid == 488697 ~ 1,
                                nid == 77395 ~ 1, 
                                nid %in% c(107174,107172,107123,236187,236213,265259,335931,387644) ~ 1, 
                                nid == 12489 ~ 1, 
                                nid == 74460 ~ 1, 
                                nid == 446732 ~ 1,
                                nid == 416582 ~ 0,
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                location_id == 130 & (val == 0 | val == 0.00)  ~ 1, #Mexico outleir if at 0                              
                               location_id == 141 & val == 0 ~ 1,
                               nid == 260403 ~ 1, 
                               location_id == 44860 ~ 0,
                               TRUE ~ is_outlier))
pub_prim = pub_prim %>% filter(location_id %in% c(179,44861,44853,44854,44857,44862,44860,44859,44855,60908,44856,94364,95069,44852))
openxlsx::write.xlsx(pub_prim, "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/pub_prim/delivery_location_bundle_10556_pub_prim_2025-06-05.xlsx", 
                     rowNames = FALSE, 
                     sheetName="extraction")

# priv_prim
priv_prim <- get_crosswalk_version(priv_prim_crosswalk_version_id)
priv_prim$variance <- ifelse(priv_prim$variance <= 1e-12, 1e-11, priv_prim$variance)

priv_prim <- priv_prim %>% 
  mutate(is_outlier = case_when(nid == 395908 ~ 1,
                                nid == 81748 ~ 0,
                                nid == 20947 ~ 0,
                                nid == 20829 ~ 0,
                                nid == 19391 ~ 1,
                                nid == 27615 ~ 1,
                                nid == 77388 ~ 0,
                                nid == 440151 ~0,
                                nid == 20954 ~ 0,
                                nid == 32421 ~ 0,
                                nid == 234733 ~ 0,
                                nid == 223669 ~ 0, 
                                nid == 218555 ~ 0,
                                nid == 462027 ~ 1, 
                                nid == 504808 ~ 1,
                                nid == 56151 ~ 1, 
                                nid == 327591 ~ 1,
                                nid == 4779 ~ 1,
                                nid == 19464 ~ 1, 
                                nid == 504808 ~ 1,
                                nid == 396050 ~ 1, 
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid == 393876 ~ 1,
                                nid == 76709 ~ 1, 
                                nid == 13465 ~ 1,
                                nid == 200697 & year_id %in% c(2013:2014) ~ 1, 
                                nid == 9516 ~1,
                                nid == 8115 ~ 1, 
                                nid == 303458 ~ 1, 
                                nid == 21126~1, 
                                nid == 18815 ~ 1, 
                                nid == 230049 ~ 1, 
                                nid == 55956 ~ 1, 
                                nid == 12489 ~ 1,
                                nid == 12455 ~ 1,
                                nid == 74460 ~ 1,
                                nid == 341838 ~ 1,
                                nid == 157021 ~ 1, 
                                nid == 20638 ~ 1, 
                                nid == 407869 ~ 1, 
                                nid == 452894 ~ 1, 
                                nid == 10364 ~ 0, 
                                nid == 483328 ~ 1, 
                                nid == 8618 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 8667 ~ 1,
                                nid == 343465 ~ 1,
                                nid == 483328 ~ 1,
                                nid == 383328 ~ 1, 
                                nid == 387640 ~ 1,
                                nid == 468566 ~ 1, 
                                nid == 45777 ~ 1,
                                nid == 26998 ~ 1, 
                                nid == 76878 ~ 1,
                                nid == 30431 ~ 1,
                                nid == 20235 ~ 1,
                                nid == 206075 ~ 1, 
                                nid == 20852 ~ 1, 
                                nid == 20875 ~ 1, 
                                nid == 8684 ~ 1, 
                                nid == 77395 ~ 1, 
                                nid == 31831 ~ 1,
                                nid == 31797 ~ 1,
                                nid == 12672 ~ 1, 
                                nid == 20841 ~ 1, 
                                nid == 19350 ~ 1, 
                                nid == 12455 ~ 1, 
                                nid == 12489 ~ 1, 
                                nid == 74460 ~ 1, 
                                nid == 77395 ~ 1,
                                nid == 20947 ~ 0,
                                nid == 18854 ~ 1,
                                nid == 416582 ~ 0,
                                location_id == 44860 ~ 0,
                                nid == 509345 & year_id %in% c(2020,2021) ~ 1,
                                nid == 488697 ~ 1,
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid %in% c(1855,22950,18499) & year_id %in% (1990:2007) ~ 1,
                                nid %in% c(107174,107172,107123,236187,236213,265259,335931,387644) ~ 1, 
                                location_id == 141 & (val == 0.000 | val == 0)  ~ 1,  
                                nid == 260403 ~ 1, 
                                location_id == 130 & (val == 0 | val == 0.00)  ~ 1, #Mexico outleir if at 0                              
                                TRUE ~ is_outlier))
priv_prim = priv_prim %>% mutate(is_outlier = case_when(
  nid == 81748 ~ 1,
  TRUE ~ is_outlier
))
priv_prim = priv_prim %>% filter(location_id %in% c(179,44861,44853,44854,44857,44862,44860,44859,44855,60908,44856,94364,95069,44852))
openxlsx::write.xlsx(priv_prim, "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/priv_prim/delivery_location_bundle_10557_priv_prim_2025-06-05.xlsx", 
                     rowNames = FALSE, 
                     sheetName="extraction")

## saving new crosswalk version
save_crosswalk_version(bundle_version_id = pub_hosp_bundle_version_id, 
                       # data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/pub_hosp/delivery_location_bundle_10530_pub_hosp_2025-06-05.xlsx",
                       data_filepath = paste0("/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/delivery_location_bundle_10530_pub_hosp_", VERSION, ".xlsx"),
                       description = "add Brazil SIH admin data w increased standard error")

save_crosswalk_version(bundle_version_id = priv_hosp_bundle_version_id, 
                       data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/priv_hosp/delivery_location_bundle_10554_priv_hosp_2025-06-05.xlsx",
                       description = "eth only")

save_crosswalk_version(bundle_version_id = pub_prim_bundle_version_id, 
                       data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/pub_prim/delivery_location_bundle_10556_pub_prim_2025-06-05.xlsx",
                       description = "eth only")

save_crosswalk_version(bundle_version_id = priv_prim_bundle_version_id, 
                       data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/priv_prim/delivery_location_bundle_10557_priv_prim_2025-06-05.xlsx",
                       description = "eth only")

#### Outliering 3 rounds in 1 for hosp_any and prim_any ####
## defining variables
hosp_any_crosswalk_version_id <- 48862
hosp_any_bundle_version_id <- 50435
prim_any_crosswalk_version_id <- 48863
prim_any_bundle_version_id <- 50436

## pulling crosswalk versions and updating outliers
# hosp_any
hosp_any <- get_crosswalk_version(hosp_any_crosswalk_version_id)
hosp_any <- mutate(hosp_any,variance = if_else(variance <= 1e-12, 1e-11, variance))
hosp_any <- hosp_any %>% 
  ## initial outliers
  mutate(is_outlier = case_when(nid == 18920 ~ 0, 
                                nid == 218565 ~ 1, 
                                nid == 18913 & year_id %in% c(2003, 2006, 2007) ~ 0, 
                                nid == 244455 & year_id %in% c(2013, 2014) ~ 0, 
                                nid == 19350 ~ 0,
                                nid == 56151 ~ 1, 
                                nid == 19391 ~ 1,
                                nid == 27615 ~ 1,
                                nid == 77388 ~ 0,
                                nid == 327591 ~ 1,
                                nid == 440151 ~0,
                                nid == 376265 & year_id %!in% c(2014:2015) ~ 1,
                                nid == 76850 & year_id == 2010 ~ 0, 
                                nid == 18531 ~ 0, 
                                nid == 488697 & year_id %in% c(2018, 2019) ~ 1, 
                                nid == 19521 ~ 0,
                                nid == 26842 & year_id %in% c(2004, 2005) ~ 0,
                                nid == 19604 & year_id == 1993 ~ 0,
                                nid == 56241 & year_id %in% c(2009, 2010) ~ 1,
                                nid == 19670 ~ 0,
                                nid == 4905 & year_id %in% c(1990, 1991) ~ 0,
                                nid == 19695 & year_id %in% c(1991, 1992, 1993) ~ 0, 
                                nid == 19708 ~ 0, 
                                nid == 13218 & year_id == 1999 ~ 1,
                                nid == 6464 ~ 0, 
                                nid == 219201 & year_id == 2008 ~ 0,
                                nid == 264956 & year_id %in% c(2010, 2011, 2012, 2013) ~ 0,
                                nid == 20060 & year_id %in% c(1993, 1997) ~ 0,
                                nid == 20073 ~ 0, 
                                nid == 155335 & year_id %in% c(2006, 2007) ~ 1,
                                nid == 394719 & year_id %in% c(2017, 2018) ~ 1, 
                                nid == 20235 & year_id %in% c(1990, 1991, 1992) ~ 0, 
                                nid == 20450 ~ 0, 
                                nid == 286782 ~ 0, 
                                nid == 20537 ~ 0, 
                                nid == 462027 ~ 1,
                                nid == 12608 & year_id %in% c(2004, 2005) ~ 0, 
                                nid == 20875 ~ 0, 
                                nid == 77395 & year_id %in% c(2010, 2011) ~ 0, 
                                nid == 21151 ~ 0, 
                                nid == 21163 & year_id == 2003 ~ 0, 
                                nid == 35493 & year_id %in% c(2008, 2009) ~ 0, 
                                nid == 56148 ~ 0,
                                nid == 509345 & year_id %in% c(2020, 2021) ~ 1,
                                nid == 19188 & year_id == 1990 ~ 0,
                                nid == 393876 ~ 1,
                                nid == 31750 ~ 0,
                                nid == 4905 & year_id %in% c(1990, 1991) ~ 0,
                                ## second round
                                nid == 74393 & year_id %in% c(2011, 2012) ~ 0,
                                nid == 504808 ~ 1,
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid == 20947 ~ 0,
                                nid == 27215 ~ 0,
                                ## third round - Mexico
                                nid == 395908 ~ 1,
                                nid == 81748 ~ 0,
                                nid == 4779 ~ 1, 
                                nid == 396050 ~ 1, 
                                nid == 21126 ~ 1,
                                nid == 230049 ~ 1, 
                                nid == 55956 ~ 1,
                                nid == 157021 ~ 1,
                                nid == 20638 ~ 1, 
                                nid == 407869 ~ 1, 
                                nid == 452894 ~ 1, 
                                nid == 218566 ~ 1, 
                                nid == 218566 ~ 1, 
                                nid == 21281 & year_id %!in% (2008:2009) ~ 1, ##check!
                                nid == 483328 ~ 1, 
                                nid == 8618 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 8667 ~ 1,
                                nid == 18854 ~ 1,
                                nid == 343465 ~ 1,
                                nid == 483328 ~ 1,
                                nid == 383328 ~ 1, 
                                nid == 387640 ~ 1,
                                nid ==	20954 & year_id %in% c(1999:2003) ~ 0,
                                nid == 468566 ~ 1, 
                                nid == 45777 ~ 1,
                                nid == 8684 ~ 1, 
                                nid ==	77518 & year_id %in% c(2008:2012) ~ 1,
                                nid == 12489 ~ 1,
                                nid == 12455 ~ 1,
                                nid == 74460 ~ 1,
                                nid == 19391 ~ 1,
                                nid == 341838 ~ 1,
                                nid == 260403 ~ 1, 
                                nid == 153674 ~ 1,
                                location_id == 44860 ~ 0,
                                nid == 416582 ~ 0,
                                #nid %in% c(107174,107172,107123,236187,236213,265259,335931,387644) ~ 1, 
                                location_id == 141 & (val == 0.000 | val == 0)  ~ 1, 
                                location_id == 130 & (val == 0 | val == 0.00)  ~ 1, #Mexico outleir if at 0  
                                nid %in% c(1855,22950,18499) & year_id %in% (1990:2007) ~ 1,
                                #nid == 341838 ~ 1, 
                                TRUE ~ is_outlier))
hosp_any = hosp_any %>% filter(location_id %in% c(179,44861,44853,44854,44857,44862,44860,44859,44855,60908,44856,94364,95069,44852))
#hosp_any = mutate(hosp_any, variance = ifelse(variance < 1e-12, 1e-12, variance))
openxlsx::write.xlsx(hosp_any, "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/any_hosp/delivery_location_bundle_10634_hosp_any_2025-06-05.xlsx", 
                     rowNames = FALSE, 
                     sheetName="extraction")

# prim_any
prim_any <- get_crosswalk_version(prim_any_crosswalk_version_id)
prim_any <- mutate(prim_any,variance = if_else(variance <= 1e-12, 1e-11, variance))
prim_any <- prim_any %>% 
  ## initial outliers
  mutate(is_outlier = case_when(nid == 18920 ~ 0, 
                                nid == 18913 & year_id %in% c(2003, 2006, 2007) ~ 0, 
                                nid == 244455 & year_id %in% c(2013, 2014) ~ 0, 
                                nid == 19350 ~ 0,
                                nid == 376265  ~1, 
                                nid == 19391 ~ 1,
                                nid == 153674 ~ 1,
                                nid == 27615 ~ 1,
                                nid == 56151 ~ 1,
                                nid == 327591 ~ 1,
                                nid == 76850 & year_id == 2010 ~ 0, 
                                nid == 18531 ~ 0, 
                                nid == 19521 ~ 0,
                                nid == 56151 ~ 1, 
                                nid == 26842 & year_id %in% c(2004, 2005) ~ 0,
                                nid == 19604 & year_id == 1993 ~ 0,
                                nid == 56241 & year_id %in% c(2009, 2010) ~ 1,
                                nid == 19670 ~ 0,
                                nid == 4905 & year_id %in% c(1990, 1991) ~ 0,
                                nid == 19695 & year_id %in% c(1991, 1992, 1993) ~ 0, 
                                nid == 19708 ~ 0, 
                                nid == 6464 ~ 0, 
                                nid == 219201 & year_id == 2008 ~ 0,
                                nid == 264956 & year_id %in% c(2010, 2011, 2012, 2013) ~ 0,
                                nid == 20060 & year_id %in% c(1993, 1997) ~ 0,
                                nid == 20073 ~ 0, 
                                nid == 155335 & year_id %in% c(2006, 2007) ~ 1,
                                nid == 394719 & year_id %in% c(2017, 2018) ~ 1, 
                                nid == 20235 & year_id %in% c(1990, 1991, 1992) ~ 0, 
                                nid == 20450 ~ 0, 
                                nid == 286782 ~ 0, 
                                nid == 20537 ~ 0, 
                                nid == 12608 & year_id %in% c(2004, 2005) ~ 0, 
                                nid == 20875 ~ 0, 
                                nid == 440151 ~0,
                                nid == 77395 & year_id %in% c(2010, 2011) ~ 0, 
                                nid == 21151 ~ 0, 
                                nid == 21163 & year_id == 2003 ~ 0, 
                                nid == 35493 & year_id %in% c(2008, 2009) ~ 0, 
                                nid == 56148 ~ 0,
                                nid == 509345 & year_id %in% c(2020, 2021) ~ 1,
                                nid == 19188 & year_id == 1990 ~ 0,
                                nid == 393876 ~ 1,
                                nid == 31750 ~ 0,
                                nid == 218565 ~ 1,
                                nid == 4905 & year_id %in% c(1990, 1991) ~ 0,
                                ## second round
                                nid == 74393 & year_id %in% c(2011, 2012) ~ 0,
                                nid == 504808 & year_id %in% c(2017, 2018, 2019, 2020) ~ 1,
                                nid == 76708 & year_id %in% c(2010, 2011) ~ 1,
                                nid == 20947 ~ 0,
                                nid == 27215 ~ 0,
                                ## third round - Mexico
                                nid == 395908 ~ 1,
                                nid == 81748 ~ 0,
                                nid == 95336 & year_id %in% c(2006:2010) ~ 1,
                                nid == 21609 & year_id %in% c(1999:2003) ~ 1,
                                nid == 21608 & year_id %in% c(2004:2005) ~ 1,
                                (nid == 608 | nid == 13571) & year_id %in% c(2003:2012) ~ 1,
                                nid == 504808 & year_id %in% c(2021) ~ 1,
                                (nid == 407689 | nid == 452894) & year_id %in% c(2014:2019) ~ 1,
                                nid == 41837 & year_id %in% c(2002:2006) ~ 1,
                                (nid == 21832 | nid == 11240) & year_id %in% c(1999:2003) ~ 1,
                                #adding in outliers from previous prim_any vetting sheet,
                                nid ==	18854 & year_id %in% c(2001:2005) ~ 1,
                                nid ==	21676 & year_id %in% c(1998:2001) ~ 0,
                                nid ==	7340 & year_id %in% c(2004) ~ 0,
                                nid ==	76702 & year_id %in% c(2008) ~ 0,
                                nid ==	77518 & year_id %in% c(2008:2012) ~ 1,
                                nid ==	7540 & year_id %in% c(2004) ~ 0,
                                nid ==	162283 & year_id %in% c(2012) ~ 0,
                                nid ==	408226 & year_id %in% c(2016) ~ 0,
                                nid ==	189045 & year_id %in% c(2011:2012) ~ 1,
                                nid ==	1208 & year_id %in% c(2004:2005) ~ 1,
                                nid ==	453549 & year_id %in% c(2018:2019) ~ 0,
                                nid ==	13445 & year_id %in% c(2004) ~ 0,
                                nid ==	21643 & year_id %in% c(2002) ~ 0,
                                nid ==	150526 & year_id %in% c(2011) ~ 0,
                                nid ==	56153 & year_id %in% c(2008) ~ 0,
                                nid ==	156268 & year_id %in% c(2011) ~ 0,
                                nid ==	150870 & year_id %in% c(2012) ~ 0,
                                nid ==	462027 ~ 1,
                                nid ==	462027 & year_id %in% c(2018:2019) ~ 0,
                                nid ==	459477 & year_id %in% c(2018:2019) ~ 1,
                                nid ==	21848 & year_id %in% c(2000) ~ 0,
                                nid ==	13218 & year_id %in% c(1998,1999) ~ 1,
                                nid ==	21962 & year_id %in% c(1998:2001) ~ 0,
                                nid ==	132739 & year_id %in% c(2010) ~ 0,
                                nid ==	18990 & year_id %in% c(1991:2003) ~ 0,
                                nid ==	18971 & year_id %in% c(1994:1998) ~ 0,
                                nid ==	20648 & year_id %in% c(1996:1999) ~ 0,
                                nid ==	275090 & year_id %in% c(1999:2001) ~ 0,
                                nid ==	169975 & year_id %in% c(2012) ~ 0,
                                nid ==	464145 & year_id %in% c(2017) ~ 0,
                                nid ==	21567 & year_id %in% c(2012) ~ 0,
                                nid ==	200697 & year_id %in% c(2013:2014) ~ 1,
                                nid ==	200697 & year_id %in% c(2013:2014) ~ 1,
                                nid ==	4905 & year_id %in% c(1990:1992) ~ 0,
                                nid ==	4926 & year_id %in% c(2006) ~ 0,
                                nid ==	200598 & year_id %in% c(2012) ~ 0,
                                nid ==	474221 & year_id %in% c(2017) ~ 0,
                                nid ==	26680 & year_id %in% c(2005:2008) ~ 0,
                                nid ==	27894 & year_id %in% c(1993) ~ 0,
                                nid ==	543576 & year_id %in% c(2020) ~ 0,
                                nid ==	19359 & year_id %in% c(1996:2000) ~ 0,
                                nid ==	19324 & year_id %in% c(2001:2003) ~ 0,
                                nid ==	21281 ~ 1,
                                nid ==	218556 & year_id %in% c(2011:2013) ~ 0,
                                nid ==	452953 & year_id %in% c(2016) ~ 0,
                                nid ==	21635 & year_id %in% c(1999:2003) ~ 0,
                                nid ==	45718 & year_id %in% c(1999:2000) ~ 0,
                                nid ==	335901 & year_id %in% c(2016) ~ 0,
                                nid ==	398900 & year_id %in% c(2017) ~ 0,
                                nid ==	427996 & year_id %in% c(2018) ~ 0,
                                nid ==	465106 & year_id %in% c(2019) ~ 0,
                                nid ==	491323 & year_id %in% c(2020) ~ 0,
                                nid ==	515115 & year_id %in% c(2022) ~ 0,
                                nid ==	9422 & year_id %in% c(1998:2001) ~ 0,
                                nid ==	10224 & year_id %in% c(2003) ~ 0,
                                nid ==	21489 & year_id %in% c(1999:2007) ~ 0,
                                nid ==	195010 & year_id %in% c(2013) ~ 0,
                                nid ==	324470 & year_id %in% c(2015:2016) ~ 0,
                                nid ==	26842 & year_id %in% c(2006:2008) ~ 0,
                                nid ==	7054 & year_id %in% c(1999) ~ 0,
                                nid ==	23565 & year_id %in% c(2001:2004) ~ 0,
                                nid ==	7028 & year_id %in% c(2004) ~ 0,
                                nid ==	76707 & year_id %in% c(2009) ~ 0,
                                nid ==	385708 & year_id %in% c(2016) ~ 0,
                                nid ==	20060 & year_id %in% c(1994:1996) ~ 0,
                                nid ==	7688 & year_id %in% c(2003:2005) ~ 0,
                                nid ==	76708 & year_id %in% c(2010:2011) ~ 0,
                                nid ==	142186 & year_id %in% c(1994:1995) ~ 0,
                                nid ==	125591 & year_id %in% c(2008) ~ 0,
                                nid ==	161590 & year_id %in% c(2010:2014) ~ 0,
                                nid ==	464593 & year_id %in% c(2017) ~ 0,
                                nid ==	69911 & year_id %in% c(2010) ~ 0,
                                nid ==	153643 & year_id %in% c(2008) ~ 0,
                                nid ==	200617 & year_id %in% c(2012) ~ 0,
                                nid ==	21901 & year_id %in% c(1999:2003) ~ 0,
                                nid ==	409558 & year_id %in% c(2016) ~ 0,
                                nid ==	76709 ~ 1,
                                nid ==	20954 & year_id %in% c(1999:2003) ~ 0,
                                nid ==	21917 & year_id %in% c(2000:2003) ~ 0,
                                nid ==	21068 & year_id %in% c(1990:1991) ~ 0,
                                nid ==	21468 & year_id %in% c(1999:2003) ~ 0,
                                nid ==	9515 & year_id %in% c(2003) ~ 0,
                                nid ==	55956 ~ 1,
                                nid ==	157021 ~ 1,
                                nid ==	230049 & year_id %in% c(2013:2014) ~ 1,
                                nid ==	45777 & year_id %in% c(1993,1997) ~ 0,
                                nid ==	21653 & year_id %in% c(1999:2003) ~ 0,
                                nid ==	26919 & year_id %in% c(2004) ~ 0,
                                nid ==	23183 & year_id %in% c(1999) ~ 1,
                                nid ==	21785 & year_id %in% c(1999:2003) ~ 0,
                                nid ==	21785 & year_id %in% c(2003) ~ 0,
                                nid ==	20462 & year_id %in% c(2005) ~ 0,
                                nid ==	94168 & year_id %in% c(2006) ~ 0,
                                nid ==	21240 & year_id %in% c(2007:2011) ~ 0,
                                nid ==	9720 & year_id %in% c(1997) ~ 0,
                                nid ==	21803 & year_id %in% c(1999:2003) ~ 0,
                                nid ==	415690 & year_id %in% c(2006) ~ 0,
                                nid ==	165908 & year_id %in% c(2008) ~ 0,
                                nid ==	153667 & year_id %in% c(2011) ~ 0,
                                nid ==	238338 & year_id %in% c(2013) ~ 0,
                                nid ==	446732 & year_id %in% c(2014:2015) ~ 0,
                                nid ==	487290 & year_id %in% c(2018) ~ 0,
                                nid ==	426238 & year_id %in% c(2012:2013) ~ 0,
                                nid ==	19167 & year_id %in% c(2002:2004) ~ 0,
                                location_id == 10 & year_id %in% c(2005:2012) ~ 0,
                                nid ==	142943 & year_id %in% c(2010, 2012:2013) ~ 0,
                                nid ==	326837 & year_id %in% c(2012:2016) ~ 0,
                                nid ==	12732 & year_id %in% c(2003) ~ 0,
                                nid ==	529982 & year_id %in% c(2020:2021) ~ 0,
                                nid ==	76878 & year_id %in% c(2009:2013) ~ 0,
                                nid ==	76706 & year_id %in% c(2008:2009) ~ 0,
                                nid ==	76850 & year_id %in% c(2008) ~ 0,
                                location_id == 179 & year_id %in% c(1997:2008) ~ 0,
                                nid ==	7440 & year_id %in% c(1993:1997) ~ 0,
                                nid ==	20132 & year_id %in% c(1996:1998) ~ 0,
                                nid ==	394719 & year_id %in% c(2016:2017) ~ 0,
                                nid ==	20212 & year_id %in% c(1995) ~ 0,
                                nid ==	125594 & year_id %in% c(2011:2012) ~ 0,
                                nid ==	7919 & year_id %in% c(2005:2006) ~ 0,
                                nid ==	55975 & year_id %in% c(2010:2011) ~ 0,
                                nid ==	20722 & year_id %in% c(1996) ~ 0,
                                nid ==	21222 & year_id %in% c(2003) ~ 0,
                                nid ==	91508 & year_id %in% c(2009, 2011) ~ 0,
                                nid ==	91507 & year_id %in% c(2009:2011) ~ 0,
                                nid ==	81004 & year_id %in% c(2006, 2008:2009) ~ 0,
                                nid ==	142935 & year_id %in% c(2008:2011) ~ 0,
                                nid ==	264959 & year_id %in% c(2012:2013) ~ 0,
                                nid ==	416595 & year_id %in% c(2012, 2014) ~ 0,
                                nid ==	466997 & year_id %in% c(2017:2018) ~ 0,
                                nid ==	20852 & year_id %in% c(1992) ~ 0,
                                nid ==	77395 & year_id %in% c(2007:2009) ~ 0,
                                nid ==	327591 & year_id %in% c(2013:2015) ~ 0,
                                nid ==	26702 & year_id %in% c(2004:2008) ~ 0,
                                nid ==	7721 & year_id %in% c(2000) ~ 0,
                                nid ==	157058 & year_id %in% c(2010,2012) ~ 0,
                                nid ==	21163 & year_id %in% c(2991:2002, 2004:2005) ~ 0,
                                nid ==	152720 & year_id %in% c(2013:2014) ~ 0,
                                nid ==	18950 & year_id %in% c(1998) ~ 0,
                                nid ==	22950 & year_id %in% c(2001:2005) ~ 1,
                                nid ==	18499 & year_id %in% c(2006:2007) ~ 1,
                                nid ==	19315 & year_id %in% c(2004) ~ 0,
                                nid ==	160576 & year_id %in% c(2003) ~ 0,
                                nid ==	56241 & year_id %in% c(2009:2010) ~ 0,
                                nid ==	218572 & year_id %in% c(2013:2017) ~ 0,
                                nid ==	527726 & year_id %in% c(2020:2022) ~ 0,
                                nid ==	20191 & year_id %in% c(2002) ~ 0,
                                nid ==	286768 & year_id %in% c(2012:2014) ~ 0,
                                nid ==	77388 & year_id %in% c(2008:2012) ~ 0,
                                nid ==	20322 & year_id %in% c(1996, 2000) ~ 0,
                                nid ==	152783 & year_id %in% c(2010) ~ 0,
                                nid ==	9522 & year_id %in% c(2002:2006) ~ 1,
                                nid ==	464540 & year_id %in% c(2018:2019) ~ 0,
                                nid ==	21258 & year_id %in% c(2004) ~ 0,
                                nid == 4779 ~ 1, 
                                nid == 396050 ~ 1, 
                                nid == 76709 ~ 1, 
                                nid == 21126 ~ 1, 
                                nid == 230049 ~ 1, 
                                nid == 20638 ~ 1, 
                                nid == 19464 ~ 1, 
                                nid == 504808 ~ 1,
                                nid == 407869 ~ 1, 
                                nid == 452894 ~ 1, 
                                nid == 218566 ~ 1, 
                                nid == 218256 ~ 1,
                                nid == 10364 ~ 1, 
                                nid == 483328 ~ 1, 
                                nid == 8618 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 8667 ~ 1,
                                nid == 343465 ~ 1,
                                nid == 483328 ~ 1,
                                nid == 383328 ~ 1, 
                                nid == 387640 ~ 1,
                                nid == 468566 ~ 1, 
                                nid == 45777 ~ 1,
                                nid == 12103 ~ 1, 
                                nid == 20796 ~ 1,
                                nid == 21864 ~ 1,
                                nid == 11781 ~ 1,
                                nid == 8684 ~ 1, 
                                nid == 12489 ~ 1,
                                nid == 12455 ~ 1,
                                nid == 74460 ~ 1,
                                nid == 341838 ~ 1,
                                nid == 260403 ~ 1, 
                                nid == 450477 ~ 1,
                                location_id == 44860 ~ 0,
                                nid == 416582 ~ 0,
                                nid %in% c(107174,107172,107123,236187,236213,265259,335931,387644) ~ 1, 
                                location_id == 141 & (val == 0 | val == 0.00)  ~ 1, #Egypt outlier if at 0
                                location_id == 130 & (val == 0 | val == 0.00)  ~ 1, #Mexico outleir if at 0                              
                                TRUE ~ is_outlier))
prim_any = prim_any %>% mutate(is_outlier = case_when(location_id == 48860 ~0,
                                                      nid == 416582 ~ 0,
                                                      TRUE ~ is_outlier))
prim_any = prim_any %>% filter(location_id %in% c(179,44861,44853,44854,44857,44862,44860,44859,44855,60908,44856,94364,95069,44852))
openxlsx::write.xlsx(prim_any, "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/any_prim/delivery_location_bundle_10635_prim_any_2025-06-05.xlsx", 
                     rowNames = FALSE, 
                     sheetName="extraction")

#### NGO_hosp ####
ngo_hosp <- get_crosswalk_version(ngo_hosp_crosswalk_version_id)
ngo_hosp$variance <- ifelse(ngo_hosp$variance <= 1e-12, 1e-11, ngo_hosp$variance)

ngo_hosp <- ngo_hosp %>% 
  mutate(is_outlier = case_when(nid==7401 ~ 1, 
                                nid==155335 & year_id %in% c(2006, 2007) ~ 1, 
                                nid==394719 & year_id %in% c(2017, 2018) ~ 1,
                                nid==7919 & year_id %in% c(2005, 2006) ~ 1,
                                nid==20865 ~ 1, 
                                nid==20852 ~ 1, 
                                nid==20841 ~ 1, 
                                nid==20875 ~ 0, 
                                nid==55992 ~ 1,
                                nid==21163 ~ 1,
                                nid==19211 ~ 1,
                                nid==244455 & year_id %in% c(2013,2014) ~ 0,
                                nid==230049 & year_id %in% c(2013,2014) ~ 1,
                                nid==151086 & year_id %in% c(2011,2012) ~ 1,
                                nid==434764 & year_id %in% c(2018,2019) ~ 1,
                                nid==30325 ~ 1,
                                nid==464593 ~ 1, 
                                nid==200707 ~ 1, 
                                nid==152720 ~ 1, 
                                TRUE ~ is_outlier))

openxlsx::write.xlsx(ngo_hosp, "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_pre_gpr/ngo_hosp/xwalk_bundle_ngo_hosp_2025-09-22.xlsx", 
                     rowNames = FALSE, 
                     sheetName="extraction")

save_crosswalk_version(bundle_version_id = ngo_hosp_bundle_version_id, 
                       data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_pre_gpr/ngo_hosp/xwalk_bundle_ngo_hosp_2025-09-22.xlsx",
                       description = "third round outliers")

####NGO lower level
ngo_prim <- get_crosswalk_version(ngo_prim_crosswalk_version_id)
ngo_prim$variance <- ifelse(ngo_prim$variance <= 1e-12, 1e-11, ngo_prim$variance)

ngo_prim <- ngo_prim %>% 
  mutate(is_outlier = case_when(nid==7919 & year_id %in% c(2005, 2006) ~ 1,
                                nid==20865 ~ 1, 
                                nid==20875 ~ 0,
                                nid==21163 ~ 1,
                                nid==19211 ~ 1,
                                nid==244455 & year_id %in% c(2013,2014) ~ 0,
                                nid==26702 ~ 1,
                                TRUE ~ is_outlier))

openxlsx::write.xlsx(ngo_prim, "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_pre_gpr/ngo_prim/xwalk_bundle_ngo_prim_2025-09-22.xlsx", 
                     rowNames = FALSE, 
                     sheetName="extraction")

save_crosswalk_version(bundle_version_id = ngo_prim_bundle_version_id, 
                       data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_pre_gpr/ngo_prim/xwalk_bundle_ngo_prim_2025-09-22.xlsx",
                       description = "first outliers")


## saving new crosswalk version
save_crosswalk_version(bundle_version_id = hosp_any_bundle_version_id, 
                       data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/any_hosp/delivery_location_bundle_10634_hosp_any_2025-06-05.xlsx",
                       description = "eth only")

save_crosswalk_version(bundle_version_id = prim_any_bundle_version_id, 
                       data_filepath = "/ihme/scratch/projects/hssa/pcp/delivery_location_remapping/mcconrad_xw_bundles/any_prim/delivery_location_bundle_10635_prim_any_2025-06-05.xlsx",
                       description = "eth only")
